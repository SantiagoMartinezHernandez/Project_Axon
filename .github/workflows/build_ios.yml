name: Build iOS IPA
on:
  push:
    branches: [ "main" ]
jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Configure & Build IPA
        run: |
          # 1. Enter the Project Folder (CRITICAL FIX)
          cd axon_satellite
          
          # 2. Get Dependencies
          flutter pub get
          
          # 3. Enter iOS folder for Surgery
          cd ios
          
          # --- SURGERY STEP A: Force iOS 15.0 (Podfile) ---
          rm -f Podfile.lock
          echo "platform :ios, '15.0'" > Podfile.new
          cat Podfile >> Podfile.new
          mv Podfile.new Podfile
          
          # --- SURGERY STEP B: Force Manual Provisioning (Project File) ---
          # We don't delete the line; we REPLACE 'Automatic' with 'Manual'
          # This stops Flutter/Xcode from asking for a Team ID.
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' Runner.xcodeproj/project.pbxproj
          
          # Also clear any lingering Team IDs just in case
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          
          # Install Pods
          pod install --repo-update
          
          # 4. Go back to Flutter Root to Build
          cd ..
          
          # 5. Build using the Standard Tool (now that config is fixed)
          flutter build ios --release --no-codesign

      - name: Package IPA
        run: |
          cd axon_satellite
          mkdir Payload
          # Flutter outputs the built app here:
          mv build/ios/iphoneos/Runner.app Payload
          zip -r Axon.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Axon-Release
          path: axon_satellite/Axon.ipa