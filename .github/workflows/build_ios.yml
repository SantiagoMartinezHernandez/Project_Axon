name: Build iOS IPA
on:
  push:
    branches: [ "main" ]
jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Configure & Build IPA (Direct Mode)
        run: |
          # 1. Enter the Flutter Project Folder
          cd axon_satellite
          
          # 2. Get Dependencies
          flutter pub get
          
          # 3. Enter iOS folder for Setup
          cd ios
          
          # --- PODFILE PATCH (PYTHON DOUBLE SURGERY) ---
          python3 -c "
          import sys
          import re
          
          print('--- STARTING PODFILE SURGERY ---')
          
          try:
              with open('Podfile', 'r') as f:
                  content = f.read()
              
              # OPERATION 1: Force Platform to iOS 15.0
              # This Regex finds 'platform :ios' (even if commented with #) and replaces it.
              platform_pattern = r'(#\s*)?platform :ios, .*'
              replacement_platform = \"platform :ios, '15.0'\"
              
              if re.search(platform_pattern, content):
                  content = re.sub(platform_pattern, replacement_platform, content)
                  print('✅ Fixed: iOS Platform set to 15.0')
              else:
                  # If the line is missing entirely, prepend it
                  content = replacement_platform + '\n' + content
                  print('✅ Fixed: iOS Platform line prepended')

              # OPERATION 2: Inject No-Sign Logic into post_install
              injection = \"\"\"
                  target.build_configurations.each do |config|
                    config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                    config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                    config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
                    config.build_settings['CODE_SIGN_IDENTITY'] = ''
                    config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
                  end
              \"\"\"

              if 'flutter_additional_ios_build_settings(target)' in content:
                  content = content.replace(
                      'flutter_additional_ios_build_settings(target)', 
                      'flutter_additional_ios_build_settings(target)' + injection
                  )
                  print('✅ Fixed: No-Sign logic injected')
              else:
                  print('❌ WARNING: Could not find hook to patch!')
                  # We don't exit here because the platform fix might be enough to get further
              
              with open('Podfile', 'w') as f:
                  f.write(content)
                  
          except Exception as e:
              print(f'❌ SCRIPT ERROR: {e}')
              sys.exit(1)
          "
          
          # --- PROJECT FILE PATCH A: Switch to Manual Provisioning ---
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          
          # --- PROJECT FILE PATCH B: Disable 'Thin Binary' ---
          sed -i '' 's/embed_and_thin/embed/g' Runner.xcodeproj/project.pbxproj
          
          # Install Pods (Now with iOS 15.0 forced)
          pod install --repo-update
          
          # 4. BUILD COMMAND
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath "../build_xcode" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package IPA
        run: |
          cd axon_satellite
          mkdir Payload
          
          # Move the app from the custom build path
          mv build_xcode/Build/Products/Release-iphoneos/Runner.app Payload
          
          # Zip it into an IPA
          zip -r Axon.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Axon-Release
          path: axon_satellite/Axon.ipa