name: Build iOS IPA
on:
  push:
    branches: [ "main" ]
jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Configure & Build IPA (Direct Mode)
        run: |
          # 1. Enter the Flutter Project Folder
          cd axon_satellite
          
          # 2. Get Dependencies
          flutter pub get
          
          # 3. Enter iOS folder for Setup
          cd ios
          
          # --- PODFILE PATCH: Disable Signing for Dependencies ---
          rm -f Podfile.lock
          cat <<EOF >> Podfile

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
                config.build_settings['CODE_SIGN_IDENTITY'] = ''
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
              end
            end
          end
          EOF
          
          # --- PROJECT FILE PATCH: Switch to Manual Provisioning ---
          # This prevents xcodebuild from looking for a Team ID
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          
          # Install Pods
          pod install --repo-update
          
          # 4. BUILD COMMAND (The Critical Fix)
          # We use xcodebuild directly to bypass Flutter's CLI checks.
          # We pass CODE_SIGNING_ALLOWED=NO to skip the signing phase entirely.
          
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath "../build_xcode" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package IPA
        run: |
          cd axon_satellite
          mkdir Payload
          
          # Move the app from the custom build path
          mv build_xcode/Build/Products/Release-iphoneos/Runner.app Payload
          
          # Zip it into an IPA
          zip -r Axon.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Axon-Release
          path: axon_satellite/Axon.ipa