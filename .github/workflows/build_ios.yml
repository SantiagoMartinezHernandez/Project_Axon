name: Build iOS IPA
on:
  push:
    branches: [ "main" ]
jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Configure & Build IPA
        run: |
          # 1. Enter the Flutter Project Folder
          cd axon_satellite
          
          # 2. Get Dependencies
          flutter pub get
          
          # 3. Enter iOS folder for Setup
          cd ios
          
          # --- DIAGNOSTIC: Check if we are in the right place ---
          echo "Current Directory: $(pwd)"
          ls -R Runner.xcodeproj
          
          # --- STEP A: FORCE IOS 15.0 ---
          rm -f Podfile.lock
          sed -i '' '/platform :ios/d' Podfile
          echo "platform :ios, '15.0'" > Podfile.tmp
          cat Podfile >> Podfile.tmp
          mv Podfile.tmp Podfile
          
          # --- STEP B: INJECT NO-SIGN HOOK ---
          python3 -c "
          import sys
          print('--- PATCHING PODFILE ---')
          with open('Podfile', 'r') as f: content = f.read()
          
          injection = \"\"\"
              target.build_configurations.each do |config|
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
                config.build_settings['CODE_SIGN_IDENTITY'] = ''
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
              end
          \"\"\"
          
          if 'flutter_additional_ios_build_settings(target)' in content:
              content = content.replace('flutter_additional_ios_build_settings(target)', 'flutter_additional_ios_build_settings(target)' + injection)
              with open('Podfile', 'w') as f: f.write(content)
              print('✅ Podfile Hook Injected')
          else:
              print('❌ CRITICAL: Podfile hook target not found!')
              sys.exit(1)
          "
          
          # --- STEP C: NUCLEAR THIN BINARY PATCH ---
          # This script finds the project file and FORCEFULLY changes the script command.
          python3 -c "
          import sys, os, re
          
          path = 'Runner.xcodeproj/project.pbxproj'
          print(f'--- SEARCHING FOR PROJECT FILE AT: {path} ---')
          
          if not os.path.exists(path):
              print('❌ FILE NOT FOUND! Check your directory structure.')
              sys.exit(1)
              
          with open(path, 'r', errors='ignore') as f: content = f.read()
          
          # Regex to find 'embed_and_thin' allowing for any whitespace or quotes around it
          pattern = r'xcode_backend\.sh\\?\"? +embed_and_thin'
          replacement = 'xcode_backend.sh embed'
          
          # Check if it exists before replacing
          if re.search(pattern, content):
              new_content = re.sub(pattern, replacement, content)
              with open(path, 'w') as f: f.write(new_content)
              print('✅ SUCCESS: Replaced embed_and_thin with embed.')
          else:
              print('⚠️ WARNING: Exact match not found. Trying loose match...')
              # Fallback: Just replace the string 'embed_and_thin' anywhere
              if 'embed_and_thin' in content:
                  content = content.replace('embed_and_thin', 'embed')
                  with open(path, 'w') as f: f.write(content)
                  print('✅ SUCCESS: Replaced loose embed_and_thin match.')
              else:
                  print('❌ ERROR: Could not find any reference to embed_and_thin. The script might not be there?')
                  # We print the first 500 chars to debug if needed
                  # print(content[:500])
          
          # Also Patch Provisioning
          content = open(path, 'r', errors='ignore').read()
          content = content.replace('ProvisioningStyle = Automatic;', 'ProvisioningStyle = Manual;')
          content = content.replace('DevelopmentTeam =', 'DevelopmentTeam = \"\"; //')
          with open(path, 'w') as f: f.write(content)
          print('✅ Provisioning Patched')
          "

          # --- STEP D: INSTALL & BUILD ---
          pod install --repo-update
          
          # Clean is essential here
          xcodebuild clean -workspace Runner.xcworkspace -scheme Runner
          
          # Build using the 'Direct' method (JustFrederik style)
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath "../build_xcode" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package IPA
        run: |
          cd axon_satellite
          mkdir Payload
          # Move the compiled app into the Payload folder
          mv build_xcode/Build/Products/Release-iphoneos/Runner.app Payload
          # Zip it up
          zip -r Axon.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Axon-Release
          path: axon_satellite/Axon.ipa