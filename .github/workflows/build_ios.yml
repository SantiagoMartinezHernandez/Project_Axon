name: Build iOS IPA
on:
  push:
    branches: [ "main" ]
jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Configure & Build IPA (Direct Mode)
        run: |
          # 1. Enter the Flutter Project Folder
          cd axon_satellite
          
          # 2. Get Dependencies
          flutter pub get
          
          # 3. Enter iOS folder for Setup
          cd ios
          
          # --- PODFILE PATCH (PYTHON SURGERY) ---
          # Instead of appending a duplicate hook, we inject code into the existing one.
          python3 -c "
          import sys
          
          # Read the existing Podfile
          with open('Podfile', 'r') as f:
              content = f.read()

          # The code we want to inject to disable signing
          injection = \"\"\"
              target.build_configurations.each do |config|
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
                config.build_settings['CODE_SIGN_IDENTITY'] = ''
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
              end
          \"\"\"

          # We look for the standard Flutter line and append our injection right after it
          # This keeps it inside the 'targets.each' loop automatically.
          if 'flutter_additional_ios_build_settings(target)' in content:
              new_content = content.replace(
                  'flutter_additional_ios_build_settings(target)', 
                  'flutter_additional_ios_build_settings(target)' + injection
              )
              with open('Podfile', 'w') as f:
                  f.write(new_content)
              print('✅ Podfile successfully patched with No-Sign logic.')
          else:
              print('❌ Could not find hook to patch!')
              sys.exit(1)
          "
          
          # --- PROJECT FILE PATCH A: Switch to Manual Provisioning ---
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DevelopmentTeam = .*/DevelopmentTeam = "";/g' Runner.xcodeproj/project.pbxproj
          
          # --- PROJECT FILE PATCH B: Disable 'Thin Binary' ---
          sed -i '' 's/embed_and_thin/embed/g' Runner.xcodeproj/project.pbxproj
          
          # Install Pods (Now with the injected patch)
          pod install --repo-update
          
          # 4. BUILD COMMAND
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath "../build_xcode" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package IPA
        run: |
          cd axon_satellite
          mkdir Payload
          
          # Move the app from the custom build path
          mv build_xcode/Build/Products/Release-iphoneos/Runner.app Payload
          
          # Zip it into an IPA
          zip -r Axon.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Axon-Release
          path: axon_satellite/Axon.ipa